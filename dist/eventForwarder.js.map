{"version":3,"file":"eventForwarder.js","sources":["../src/comms.ts","../src/eventForwarder.ts"],"sourcesContent":["import type {\n  GetTablesRequest,\n  GetColumnsRequest,\n  RunQueryRequest,\n  ExpandTableResultRequest,\n  SetTabTitleRequest,\n} from \"./requestTypes\";\nimport type {\n  GetTablesResponse,\n  GetColumnsResponse,\n  GetConnectionInfoResponse,\n  GetAllTabsResponse,\n  RunQueryResponse,\n  ExpandTableResultResponse,\n  SetTabTitleResponse,\n} from \"./responseTypes\";\nimport { generateUUID } from \"./utils\";\n\n// Define a custom import.meta interface for TypeScript\ndeclare global {\n  interface ImportMeta {\n    env: {\n      MODE: string;\n    };\n  }\n}\n\nconst pendingRequests = new Map<\n  string,\n  {\n    name: string;\n    resolve: (value: any) => void;\n    reject: (reason?: any) => void;\n  }\n>();\n\nlet debugComms = false;\n\nexport function setDebugComms(value: boolean) {\n  debugComms = value;\n}\n\nwindow.addEventListener(\"message\", (event) => {\n  const { id, name, args, result, error } = event.data || {};\n\n  if (name) {\n    if (debugComms) {\n      const time = new Date().toLocaleTimeString(\"en-GB\");\n      console.groupCollapsed(`${time} [NOTIFICATION] ${name}`);\n      console.log(\"Args:\", args);\n      console.groupEnd();\n    }\n\n    const handlers = notificationListeners.get(name);\n    if (handlers) {\n      handlers.forEach((handler) => handler(args));\n    }\n  }\n\n  if (id && pendingRequests.has(id)) {\n    const { resolve, reject, name } = pendingRequests.get(id)!;\n    pendingRequests.delete(id);\n\n    if (debugComms) {\n      const time = new Date().toLocaleTimeString(\"en-GB\");\n      console.groupCollapsed(`${time} [RESPONSE] ${name}`);\n      console.log(\"Result:\", result);\n      if (error) console.error(\"Error:\", error);\n      console.groupEnd();\n    }\n\n    if (error) {\n      reject(error);\n    } else {\n      resolve(result);\n    }\n  }\n});\n\nexport async function request(name: \"getTables\", args?: GetTablesRequest[\"args\"]): Promise<GetTablesResponse>;\nexport async function request(name: \"getColumns\", args: GetColumnsRequest[\"args\"]): Promise<GetColumnsResponse>;\nexport async function request(name: \"getConnectionInfo\"): Promise<GetConnectionInfoResponse>;\nexport async function request(name: \"getAllTabs\"): Promise<GetAllTabsResponse>;\nexport async function request(name: \"runQuery\", args: RunQueryRequest[\"args\"]): Promise<RunQueryResponse>;\nexport async function request(name: \"expandTableResult\", args: ExpandTableResultRequest[\"args\"]): Promise<ExpandTableResultResponse>;\nexport async function request(name: \"setTabTitle\", args: SetTabTitleRequest[\"args\"]): Promise<SetTabTitleResponse>;\nexport async function request(name: unknown, args?: unknown): Promise<unknown> {\n  if (debugComms) {\n    const time = new Date().toLocaleTimeString(\"en-GB\");\n    console.groupCollapsed(`${time} [REQUEST] ${name}`);\n    console.log(\"Args:\", args);\n    console.groupEnd();\n  }\n\n  return new Promise<any>((resolve, reject) => {\n    try {\n      const id = generateUUID();\n      const data = { id, name, args };\n      pendingRequests.set(id, { name: name as string, resolve, reject });\n      window.parent.postMessage(data, \"*\");\n    } catch (e) {\n      reject(e);\n    }\n  });\n}\n\nexport function notify(name: string, args: any) {\n  if (debugComms) {\n    const time = new Date().toLocaleTimeString(\"en-GB\");\n    console.groupCollapsed(`${time} [NOTIFICATION] ${name}`);\n    console.log(\"Args:\", args);\n    console.groupEnd();\n  }\n  window.parent.postMessage({ name, args }, \"*\");\n}\n\nconst notificationListeners = new Map<string, ((args: any) => void)[]>();\n\nexport async function addNotificationListener(\n  name: string,\n  handler: (args: any) => void,\n) {\n  if (!notificationListeners.get(name)) {\n    notificationListeners.set(name, []);\n  }\n  notificationListeners.get(name)!.push(handler);\n}\n","/** Any events that need to be forwarded to parent/plugin system\n * must go here */\n\n/** FIXME this file must be injected from the plugin system automatically */\n\nimport { notify } from \"./comms\";\nimport { WindowEventInits, WindowEventClass } from \"./commonTypes\";\n\nfunction createEventInit<T>(event: T): {\n  eventClass: WindowEventClass;\n  eventInitOptions: WindowEventInits;\n} {\n  if (event instanceof MouseEvent) {\n    const eventInitOptions: MouseEventInit = {\n      clientX: event.clientX,\n      clientY: event.clientY,\n      screenX: event.screenX,\n      screenY: event.screenY,\n      button: event.button,\n      buttons: event.buttons,\n      altKey: event.altKey,\n      ctrlKey: event.ctrlKey,\n      shiftKey: event.shiftKey,\n      metaKey: event.metaKey,\n      movementX: event.movementX,\n      movementY: event.movementY,\n      detail: event.detail,\n    };\n    return {\n      eventClass: \"MouseEvent\",\n      eventInitOptions,\n    };\n  }\n\n  if (event instanceof PointerEvent) {\n    const eventInitOptions: PointerEventInit = {\n      clientX: event.clientX,\n      clientY: event.clientY,\n      screenX: event.screenX,\n      screenY: event.screenY,\n      button: event.button,\n      buttons: event.buttons,\n      altKey: event.altKey,\n      ctrlKey: event.ctrlKey,\n      shiftKey: event.shiftKey,\n      metaKey: event.metaKey,\n      movementX: event.movementX,\n      movementY: event.movementY,\n      detail: event.detail,\n      pointerId: event.pointerId,\n      pointerType: event.pointerType,\n      isPrimary: event.isPrimary,\n    };\n    return {\n      eventClass: \"PointerEvent\",\n      eventInitOptions,\n    };\n  }\n\n  if (event instanceof KeyboardEvent) {\n    const isPasswordField =\n      (event.target as HTMLInputElement)?.type === \"password\";\n\n    if (isPasswordField) {\n      // Avoid logging keystrokes from password fields\n      return {\n        eventClass: \"KeyboardEvent\",\n        eventInitOptions: {},\n      };\n    }\n\n    const eventInitOptions: KeyboardEventInit = {\n      key: event.key,\n      code: event.code,\n      keyCode: event.keyCode,\n      location: event.location,\n      altKey: event.altKey,\n      ctrlKey: event.ctrlKey,\n      shiftKey: event.shiftKey,\n      metaKey: event.metaKey,\n      repeat: event.repeat,\n      isComposing: event.isComposing,\n    };\n\n    return {\n      eventClass: \"KeyboardEvent\",\n      eventInitOptions,\n    };\n  }\n\n  return {\n    eventClass: \"Event\",\n    eventInitOptions: {},\n  };\n}\n\nconst forwardedEvents = [\n  \"contextmenu\",\n  \"click\",\n  \"dblclick\",\n  \"pointercancel\",\n  \"pointerdown\",\n  \"pointerenter\",\n  \"pointerleave\",\n  \"pointermove\",\n  \"pointerout\",\n  \"pointerover\",\n  \"pointerup\",\n  \"mousedown\",\n  \"mouseenter\",\n  \"mouseleave\",\n  \"mousemove\",\n  \"mouseout\",\n  \"mouseover\",\n  \"mouseup\",\n  \"keydown\",\n  \"keypress\",\n  \"keyup\",\n] as const;\n\nforwardedEvents.forEach((eventType) => {\n  document.addEventListener(eventType, (event) => {\n    const eventInit = createEventInit(event);\n    notify(\"windowEvent\", {\n      eventType,\n      eventClass: eventInit.eventClass,\n      eventInitOptions: eventInit.eventInitOptions,\n    });\n  });\n});\n"],"names":[],"mappings":"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"}